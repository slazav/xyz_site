#!/usr/bin/perl

## HTML output for news page

################################################

use strict;
use warnings;
use Try::Tiny;
use CGI ':standard';
use POSIX qw(strftime);
use JSON;
use site;
use common;
use safe_html;
use html;

################################################

try {
  ####################
  # get parameters:
  my $pars;
  $pars->{id}   = cleanup_int(param('id')||'');
  $pars->{num}  = cleanup_int(param('num')||20);
  $pars->{skip} = cleanup_int(param('skip')||0);
  $pars->{titles} = defined param('titles');

  ####################
  # open DB, get all information:
  my $db = open_db;
  my $u  = get_my_info($db);
  my $objects;
  my $o;
  if ($pars->{id}) {  $o = show_object($db, 'news', $pars); }
  else { $objects = list_objects($db, 'news', $pars); }

  ####################
  # Print everything:
  print_head($u);

  # print one
  if ($pars->{id}) {
    my $cu = mk_face($o->{cuser_info});
    my $ct = strftime "%Y-%m-%d %H:%M", localtime($o->{ctime});

    print "<div class='obj_top_panel'>$cu: $o->{title}</div>\n";
    print "<p class='news_body'>$o->{text}</p>\n";
    my $src = exists $o->{origin}? " <a href='$o->{origin}'>(источник)</a>":"";
    print "<div class='obj_bottom_panel'><i>$ct</i>$src</div>\n";
  }
  # print many
  else {

    # navigation panel
    my $n1 = $pars->{skip}+1;
    my $n2 = $pars->{skip}+1 + $pars->{num};
    my $np = ($n1 - $pars->{num} - 1 < 0)? 0 : $n1 - $pars->{num} - 1;
    my $nn = $n1 + $pars->{num} - 1;
    print "<div class=navigation>\n",
      "<a href='news?skip=$np'>&lt&lt</a> $n1..$n2 <a href='news?skip=$nn'>&gt&gt</a>\n",
      "<a href='javascript:div_show(\"news_popup\");'>[новое сообщение]</a>\n",
      "</div>\n";

    foreach my $o (@{$objects}) {
      my $cu = mk_face($o->{cuser_info});
      my $ct = strftime "%Y-%m-%d %H:%M", localtime($o->{ctime});
      $ct = "<i>$ct</i>";
      my $title = "<a href='news?id=$o->{_id}'>$o->{title}</a>";
      if ($pars->{titles}){
        print "<div class='title_panel'>$ct $cu: $title</div>\n";
      }
      else {
        my $src = exists $o->{origin}? "<a href='$o->{origin}'>(источник)</a>":"";
        $o->{ncomm} = $o->{ncomm} || 0;
        my $com = "<a href='news?id=$o->{_id}'>комментариев: $o->{ncomm}</a>";

        print "<hr><div class='obj_top_panel'>$cu: $title</div>\n";
        print "<p class='news_body'>$o->{text}</p>\n";
        print "<div class='obj_bottom_panel'>$ct, $com $src</div>\n";
      }
    }
  }

  print qq*
  <!-- Всплывающий диалог нового сообщения -->
  <div style="display:none;" id="news_popup" class="fullscreen">
  <div class="fullscreen shade"></div>
  <!-- div class="i_popup" -->
  <form action="#" class="popup" id="news_form">
    <img class="close" src="img/x.png" onclick ="div_hide('news_popup')">
    <h2>Новое собщение</h2>
    <hr class="wide">
    <input  name="id" type="hidden">
    <input  name="title" placeholder="Заголовок" type="text">
    <textarea id="text" name="text" placeholder="Текст"></textarea>
    <h4>Тип новости:</h4>
    <select name="type">
      <option>1</option>
      <option>2</option>
      <option>3</option>
    </select>
    <a href="javascript:on_news_write()" class="submit_button">Опубликовать</a>
  </form>
  </div></div>
*;

  print_tail();

################################################
}
catch {
  print_error($_, 'html');
}

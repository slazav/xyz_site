=== Пользователи


== Информация о пользователе в базе данных (коллекция MongoDB users)

* _id: идентификатор пользователя Open-id
* level: уровень (-1, 0, 1, 2, 100)
* sess:  сессия
* ctime: время первого входа
* mtime: время последнего входа
* name:  имя
* site:  провайдер (lj, google, fb, etc.)
* info:  исходная информация от провайдера (json)

== уровни доступа:
*  -1: ограниченный -- те же права, что и у анонимного пользователя,
*   0: обычный -- любой новый пользователь,
*   1: модератор -- может править чужие записи и банить обычных пользователей,
*   2: администратор -- может назначать и свергать модераторов,
* 100: самый главный -- пользователь с самыми высокими правами.


== cgi-скрипт login -- вход

Авторизация происходит через сайты loginza.ru, facebook.com, google.com.
Скрипт вызывается через один из этих сайтов, ему передаются некий код, по
которому он запрашивает информацию о пользователе. По этой инфирмации
строятся поля _id, name, site.

Создается новая сессия для пользователя. В базе даных создается
пользователь (если его еще нет) или обновляется старая запись. Если база
данных была пустой - создается пользователь с уровнем 100 (самый
главный), иначе новый пользователь имеет уровень 0 (обычный).
Устанавливается cookie SESSION (если не произошло ошибки), делается
redirect по адресу, указанному в cookie RETPAGE (если такой есть).

Информация и сообщения об ошибках сохраняются в файле logs/login.txt

NOTE: вход через facebook и через loginza+facebook дает разные id!

== cgi-скрипт logout -- выход

Скрипт получает сессию из cookie SESSION, ищет пользователя в базе
данных. Сессия обнуляется в базе данных и в cookie.

Возвращается json {ret:0} в случае успешного выполнения или {ret:1
error_message: <...>} в случае ошибки.

Информация и сообщения об ошибках сохраняются в файле logs/login.txt


== cgi-скрипт my_info -- информация о залогиненом пользователе

Скрипт получает сессию из cookie SESSION, ищет пользователя в базе
данных. Возвращается json с информацией о пользователе (кроме полей
sess и info)

== cgi-скрипт my_user_info -- информация о пользователе

Получает информацию о пользователе (кроме полей
sess и info) по его id.

== cgi-скрипт set_level -- изменение уровня доступа для другого пользователя

Изменение уровня доступа для другого пользователя. Получает сессию из
cookie SESSION, id пользователя из параметра id, новые уровень доступа из
параметра level.

По сессии находится пользователь-1.
По id находится пользователь-2. Проверяется, что его текущий уровень
пользователя-2 и новый уровень меньше уровня пользователя-1.
Уровень пользователя-2 меняется.

Возвращается json {ret:0} в случае успешного выполнения или {ret:1
error_message: <...>} в случае ошибки.


== cgi-скрипт user_list -- список пользователей

Получает сессию из cookie SESSION, проверяет, что пользователь существует
и его уровень доступа больше 0.

Выдает массив список всех пользователей со следующими изменениями:
- удаляются поля sess и info,
- для вызывающий пользователя добавляется поле me=1,
- если вызывающий пользователь может менять права доступа данного,
  то добавляется поле level_hints с массивом возможный значений уровня.


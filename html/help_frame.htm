<html>
<body>

<!------------------------------------------------------------------->
<hr><a name="pol"><h3>Пользователи</h3>

<p>Сейчас на сайте поддерживается вход через
Facebook   (<img style="top: 2px; position: relative;" src="img/fb.png">),
Google     (<img style="top: 2px; position: relative;" src="img/go.png">) и
Loginza    (<img style="top: 2px; position: relative;" src="img/loginza.png">).
Loginza, в свою очередь позволяет входить через Facebook, Google,
Yandex, Livejournal и Vkontakte. Другие способы входа могут быть сделаны
позже по просьбе пользователей. Если у вас есть аккаунт в одной из этих
соц.сетей, то, после нажатия соответвующей кнопки, эта сеть спросит у вас
разрешение на передачу информации о вашем профиле (в случае входа через
сервис Loginza, информация пройдет через него).

<p>На сайте используется минимальная информация о пользователе: имя и ссылка
на аккаунт в соц.сети. Пользователи, зашедшие из разных сетей считаются разными
людьми. К сожалению, даже вход через Facebook+Loginza и прямой вход через Facebook могут
дать разные ссылки на один аккаут. При этом получатся два разных пользователя.

<p>Каждому пользователю приписывается уровень доступа. Пока нет четкого понимания,
как их использовать, общая идея такая:

<p><b>Анонимный/ограниченный пользователь</b>. Может просматривать все
объекты. Ограниченный пользователь может редактировать и удалять объекты,
которые сам создал; удалять свои комментарии и комментарии к своим объектам.

<p><b>Обычный пользователь</b>. Кроме того, может редактировать объекты в
каталоге походов и в геоданных; создавать комментарии к любым объектам.

<p><b>Модератор</b>. Кроме того, может удалять любые объекты и комментарии;
видеть список пользователей; банить (переводить в ограниченные) и разбанивать
обычных пользователей.

<p><b>Администратор</b>. Кроме того, может редактировать объекты в списке
новостей; назначать модераторов и понижать их уровень доступа.

<p><b>Самый главный</b>. Кроме того, может назначать администраторов и
понижать их уровень доступа.

<p>Пользователь может поменять уровень доступа другого пользователя, только
если начальное и конечное значение уровня ниже его собственного уровня
доступа.

<p>Информация о пользователе в базе данных (база users)<pre><tt>
* _id: идентификатор пользователя (url)
* level: уровень (-1, 0, 1, 2, 100)
* sess:  сессия -- не выдается пользователям
* ctime: время первого входа
* mtime: время последнего входа
* name:  имя
* site:  провайдер (lj, google, fb, etc.)
* info:  исходная информация от провайдера (json) -- не выдается пользователям
</tt></pre>

<!------------------------------------------------------------------->
<hr><h3>Объекты</h3>

<p>Предполагается, что на сайте будет использоваться несколько типов
объектов-записей: новости (с заголовком, текстом и, возможно, какими-нибудь тегами),
походы в каталоге походов, объекты в каталоге геоданных.

<p>Каждый объект можно создавать, редактировать и удалять. При редактировании
и удалении сохраняются архивные копии, доступные для просмотра.

<p>К каждому объекту можно оставлять древовидные комментарии. Править
комментарий может только его создатель. Текст старых версий и удаленных
комментариев не сохраняется (хотя информация о наличии удаленного
комментария хранится). Возможно скрытие/раскрытие комментариев.

<h4>Технические подробности</h4>
<p>Общие поля в базе данных:<pre><tt>
_id   - численный идентификатор
ctime - время создания (unix time)
mtime - время последнего изменения (unix time)
dtime - время последнего удаления/восстановления (unix time)
cuser - идентификатор пользователя, создавшего объект
muser - идентификатор пользователя, последний раз менявшего объект
        (после этого пользователя никто не вносил правок)
duser - идентификатор пользователя, последний раз удалявшего/восстанавливавшего объект
ncomm - полное количество комментариев
del   - является ли объект удаленным
next  - ссылка на более новую версию (для архивных объектов)
prev  - ссылка на предыдущую архивную версию
</tt></pre>

<p>Поля, добавляемые при выдаче:<pre><tt>
cuser_info - информация о пользователе cuser (id, name, site)
muser_info - информация о пользователе muser (id, name, site)
can_delete - может ли пользователь удалить объект
can_undel  - может ли пользователь восстановить объект
can_edit   - может ли пользователь исправить объект
</tt></pre>

<p>Поля, специфичные для ленты новостей (база news):<pre><tt>
title  - заголовок
text   - текст
type   - тип новости
origin - для записи экспортированной из старой ленты - url исходной записи
</tt></pre>

<p>Поля, специфичные для каталога походов (база pcat):<pre><tt>
title  - заголовок
text   - текст
people - список людей
tags   - теги
rivers - список рек
refs   - список ссылок (поля url и text)
date1  - дата начала похода
date2  - дата окончания похода (если отличается)
</tt></pre>

<p>Поля, специфичные для геоданных:<pre><tt>
title  - заголовок
text   - текст
tags   - теги
coords - координаты
</tt></pre>

<p>Поля в базе данных комментариев (база comm):<pre><tt>
_id     - идентификатор
title   - заголовок
text    - текст
cuser   - пользователь, написавший комментарий
ctime   - время создания комментария
mtime   - время изменения комментария
coll    - к какому типу объектов относится ('news');
state   - состояние комментария ('D', 'S')
object_id  - к какому объекту относится комментарий
parent_id  - к какому комментарию относится комментарий
             (отсутствует для комментариев первого уровня)
</tt></pre>

<p>Поля комментариев, добавляемые при выдаче:<pre><tt>
cuser_info - информация о пользователе cuser (id, name, site)
can_delete - может ли пользователь удалить комментарий
can_edit   - может ли пользователь редактировать комментарий
can_screen - может ли пользователь скрыть комментарий
can_unscreen - может ли пользователь открыть комментарий
can_answer   - может ли пользователь ответить на комментарий
has_children - есть ли "живые" потомки (только для скрытых и удаленных, только при выдаче списка)
depth - глубина вложения (только при выдаче списка)
</tt></pre>


<!------------------------------------------------------------------->
<hr><h3>События</h3>

<p>Объекты, которые создаются при действиях пользователей, типа "Пользователь1 отредактировал
текст Пользователя2".
<p>...

</tt></pre>
* текст со ссылками
* затронутые пользователи (+ статус)
* время
</tt></pre>


<!------------------------------------------------------------------->
<hr><h3>Фильтрация заголовков</h3>

<p>В заголовках и т.п. полях html заменяется на простой текст (символы
"&lt;", "&gt;", "&amp;" заменяются на "&amp;lt;", "&amp;gt;",
"&amp;amp;"). Длина заголовков ограничена 1000 символов (до фильтрации).

<!------------------------------------------------------------------->
<hr><h3>Фильтрация текстов</h3>

<p>В текстах допустим только "простой html": перед показом удаляются все тэги,
кроме следующих:<pre><tt>
&lt;a&gt;     - hyperlink.
&lt;b&gt;     - bold
&lt;em&gt;     - emphasized.
&lt;h1&gt;, &lt;h2&gt;, &lt;h3&gt;, &lt;h4&gt; - headings.
&lt;i&gt;     - italic.
&lt;img&gt;   - specifies an image tag.
&lt;li&gt;    - list item in an ordered list &lt;ol&gt; or an unordered list &lt;ul&gt;.
&lt;ol&gt;    - ordered list.
&lt;p&gt;     - paragraph.
&lt;pre&gt;   - pre-element displayed in a fixed width font and and unchanged line breaks.
&lt;s&gt;     - strikethrough.
&lt;sup&gt;   - superscript text appears 1/2 character above the baseline.
&lt;sub&gt;   - subscript appears 1/2 character below the baseline.
&lt;tt&gt;    - teletype text.
&lt;ul&gt;    - unordered list.
&lt;br&gt;    - line break.
&lt;hr&gt;    - defines a thematic change in the content, usually via a horizontal line.
&lt;font&gt;  - defines the font size, color and face (obsolete in HTML).
&lt;lj-cut&gt; - for compatability with Livejournal.
</tt></pre>

В html-тегах удаляются все атрибуты, кроме следующих:<pre><tt>
В теге &lt;img&gt; - атрибуты src, width, height, alt.
В теге &lt;a&gt;   - атрибуты href, name. Атрибут href с ключевым словом "javascript:" также удаляется.
В теге &lt;font&gt; - атрибуты size, color, face.
В теге &lt;lj-cut&gt; - атрибут text.
</tt></pre>

<p>Теги и атрибуты могут набираться заглавными и строчными буквами, атрибуты могут заключаться в одинарные
или двойные кавычки, или же набираться без кавычек.

<p>Кроме того:
<ul>
<li>Длина текстов ограничена 10000 символов (до фильтрации).
<li>Переводы строк заменяются на &lt;br&gt;
<li>Теги, требующие закрытия (все, кроме img, br, hr), автоматически закрываются при необходимости.
<li>Ссылки http/https оборачиваются в тег &lt;a&gt;
</ul>

<!------------------------------------------------------------------->
<hr><h3>JSON-интерфейс</h3>

<p>Существует набор простых CGI-скриптов, которые позволяют работать с сайтом без использования html-интерфейса.
Все данные передаются в формате JSON:
<ul>

<li>login.pl -- Этот скрипт вызывается сервисом, через который происходит вход. Заправшивается информация о
пользователе, создается или обновляется запись в базе данных, создается сессия и устанавливается кука SESSION.
Если установлена кука RET, то происходит перенаправление на указанный в ней адрес.

<li>logout.pl: Выход. Сессия пользователя удаляется из базы данных.

<li><a href="cgi/my_info.pl">my_info.pl</a>: Получение информации о пользователе.

<li>set_level.pl?id=$id&level=$new_level: изменение уровня доступа другого пользователя. 

<li>news_list.pl: список новостей.

</ul>

<!------------------------------------------------------------------->
<hr><h3>Что сейчас работает</h3>

<p>Сейчас работает:<pre><tt>
Что сейчас работает:
 - вход/выход, список пользователей, возможность менять уровни доступа
 - главное меню с интерфейсом входа/выхода и несколькими страницами
 - лента новостей, поиск и навигация по новостям
 - создание, редактирование, удаление, восстановление новостей
 - экспорт новостей, комментариев и пользователей из ЖЖ
 - создание, редактирование, удаление, скрытие, раскрытие комментариев

 - каталог походов: пока ничего нет
 - тексты: пока заглушка-iframe со старым списком
 - карта: пока заглушка со статическими данными
 - справка:
 - люди: список пользователей
</tt></pre>

<p>Проблемы:<pre><tt>
 - не знаю, как найти информацию о "внешних" пользователях (которые ext_&lt;число&gt;) в комментариях ЖЖ.
</tt></pre>

</body>
</html>
